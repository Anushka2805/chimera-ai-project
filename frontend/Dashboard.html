<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Chimera - Click-to-Simulate (Model A)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <!-- Heatmap -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Tailwind (OK for demo/hackathon) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #map { height:100%; margin:0 }
    #map { min-height:60vh; border-radius:8px }
    .custom-marker {
      width:20px; height:20px; border-radius:50%;
      border:2px solid #fff;
    }
    .red-marker { background:#d10000; animation:pulseRed 2s infinite }
    .yellow-marker { background:#ffff00; animation:pulseYellow 2s infinite }

    @keyframes pulseRed {
      0% { box-shadow:0 0 0 0 rgba(255,0,0,.7) }
      70% { box-shadow:0 0 0 18px rgba(255,0,0,0) }
      100% { box-shadow:0 0 0 0 rgba(255,0,0,0) }
    }
    @keyframes pulseYellow {
      0% { box-shadow:0 0 0 0 rgba(255,255,0,.7) }
      70% { box-shadow:0 0 0 18px rgba(255,255,0,0) }
      100% { box-shadow:0 0 0 0 rgba(255,255,0,0) }
    }
  </style>
</head>

<body class="bg-[#0a192f] text-white p-4">

<h1 class="text-2xl font-bold mb-3">
  Project Chimera â€” Click-to-Simulate (Model A)
</h1>

<button id="run-sim" class="mb-3 px-4 py-2 bg-red-500 rounded font-semibold">
  Run AI Prediction
</button>

<div id="map"></div>

<div class="mt-3">
  <b>Status:</b> <span id="message-box">Ready</span>
</div>

<pre id="action-plan-text" class="mt-3 text-xs bg-black/40 p-3 rounded">
Run prediction to generate plan...
</pre>

<ul id="affected-assets-list" class="list-disc ml-6 mt-2">
  <li>No assets yet</li>
</ul>

<script>
/* MAP */
const map = L.map("map").setView([20.5937,78.9629],5);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png")
  .addTo(map);

const markersLayer = L.layerGroup().addTo(map);

/* RUN AI */
function runPrediction() {
  document.getElementById("message-box").innerText = "Contacting AI backend...";
  document.getElementById("affected-assets-list").innerHTML = "<li>Analyzing...</li>";

  fetch("/api/predict-failure", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ lat:28.6139, lng:77.209 })
  })
  .then(res => res.json())
  .then(data => {
    const assets = JSON.parse(data.failing_assets || "[]");
    document.getElementById("action-plan-text").innerText = data.action_plan;
    document.getElementById("message-box").innerText =
      assets.length + " assets detected";

    markersLayer.clearLayers();
    assets.forEach(a => {
      const cls = a.asset_type === 1 ? "red-marker" : "yellow-marker";
      L.marker([a.latitude,a.longitude], {
        icon:L.divIcon({ className:"custom-marker "+cls })
      }).addTo(markersLayer);
    });

    document.getElementById("affected-assets-list").innerHTML =
      assets.map(a => `<li>${a.asset_name}</li>`).join("");
  })
  .catch(() => {
    document.getElementById("message-box").innerText = "Backend error!";
  });
}

document.getElementById("run-sim").onclick = runPrediction;
</script>

</body>
</html>
